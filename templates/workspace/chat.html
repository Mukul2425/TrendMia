{% extends "base.html" %}

{% block title %}Workspace Chat Â· {{ project.title }}{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-8">
        <div class="workspace-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <p class="text-muted text-uppercase small mb-1">Workspace chat</p>
                    <h4 class="mb-0">{{ project.title }}</h4>
                </div>
                <a href="{% url 'workspace_dashboard' project.id %}" class="btn btn-outline-secondary btn-sm">Back to dashboard</a>
            </div>
            <div class="chat-thread" style="height:480px;">
                {% for message in messages %}
                    <div class="chat-bubble {% if message.sender == user %}me{% else %}them{% endif %}">
                        <strong>{{ message.sender.name }}</strong>
                        <p class="mb-1">{{ message.message }}</p>
                        <small class="text-muted">{{ message.timestamp|timesince }} ago</small>
                    </div>
                {% empty %}
                    <p class="text-muted small">No messages yet. Start the conversation.</p>
                {% endfor %}
            </div>
            <form id="chat-form" method="post" action="{% url 'workspace_chat' project.id %}" class="mt-3">
                {% csrf_token %}
                <div class="input-group">
                    <textarea name="message" id="message-input" class="form-control" rows="2" placeholder="Type message..." required></textarea>
                    <button class="btn btn-primary" type="submit"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </form>
            <script>
                document.getElementById('chat-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const form = this;
                    const messageInput = document.getElementById('message-input');
                    const message = messageInput.value.trim();
                    
                    if (!message) {
                        return;
                    }
                    
                    const formData = new FormData(form);
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                    
                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            messageInput.value = '';
                            
                            // Append the new message to the chat thread
                            const chatThread = document.querySelector('.chat-thread');
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'chat-bubble me';
                            messageDiv.innerHTML = `
                                <strong>${data.message.sender}</strong>
                                <p class="mb-1">${data.message.text}</p>
                                <small class="text-muted">Just now</small>
                            `;
                            chatThread.appendChild(messageDiv);
                            
                            // Scroll to bottom
                            chatThread.scrollTop = chatThread.scrollHeight;
                            
                            // Reset button
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        } else {
                            alert('Error: ' + (data.error || 'Failed to send message'));
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while sending the message');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    });
                });
            </script>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="workspace-card">
            <h6 class="text-uppercase text-muted small mb-3">Members</h6>
            <ul class="list-unstyled small mb-0">
                {% for member in members %}
                    <li class="d-flex justify-content-between">
                        <span>{{ member.user.name }}</span>
                        <span class="text-muted">{{ member.role|title }}</span>
                    </li>
                {% empty %}
                    <li class="text-muted">No collaborators yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}

