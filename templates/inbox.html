{% extends 'base.html' %}
{% load static %}

{% block title %}Messages | TRENDMIA{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4" style="color: var(--text-primary);"><i class="fas fa-inbox"></i> Messages</h2>
        </div>
    </div>

    <div class="row">
        <!-- Conversations -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3" style="color: var(--text-primary);">Following</h5>
                    {% for c in conversations_following %}
                    <div class="card mb-3" style="cursor: pointer;" onclick="window.location='{% url 'chat' c.user.username %}'">
                        <div class="card-body d-flex align-items-center">
                            <img src="{% if c.user.avatar %}{{ c.user.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ c.user.name }}&background=0a66c2&color=fff{% endif %}" 
                                 class="avatar me-3" alt="{{ c.user.name }}">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ c.user.name }}</h6>
                                <p class="mb-0 text-muted small">{{ c.last_message.message|truncatechars:80 }}</p>
                                <small class="text-muted">{{ c.time|date:"M d, H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>No conversations with people you follow yet.</p>
                    </div>
                    {% endfor %}

                    <hr class="my-4">

                    <h5 class="mb-3" style="color: var(--text-primary);">Others</h5>
                    {% for c in conversations_others %}
                    <div class="card mb-3" style="cursor: pointer;" onclick="window.location='{% url 'chat' c.user.username %}'">
                        <div class="card-body d-flex align-items-center">
                            <img src="{% if c.user.avatar %}{{ c.user.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ c.user.name }}&background=0a66c2&color=fff{% endif %}" 
                                 class="avatar me-3" alt="{{ c.user.name }}">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ c.user.name }}</h6>
                                <p class="mb-0 text-muted small">{{ c.last_message.message|truncatechars:80 }}</p>
                                <small class="text-muted">{{ c.time|date:"M d, H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>No other conversations.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Collaboration Requests -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3" style="color: var(--text-primary);"><i class="fas fa-handshake"></i> Collaboration Requests</h5>
                    
                    {% for req in collab_requests %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <img src="{% if req.requester.avatar %}{{ req.requester.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ req.requester.name }}&background=0a66c2&color=fff{% endif %}" 
                                     class="avatar avatar-sm me-2" alt="{{ req.requester.name }}">
                                <div>
                                    <strong>{{ req.requester.name }}</strong>
                                </div>
                            </div>
                            <p class="mb-2"><strong>Project:</strong> {{ req.project.title|default:req.project.project_name }}</p>
                            {% if req.role %}<p class="mb-2"><strong>Role:</strong> {{ req.role }}</p>{% endif %}
                            <small class="text-muted">{{ req.created_at|date:"M d, H:i" }}</small>
                            <div class="mt-3 d-flex gap-2">
                                <form class="collab-respond" method="post" action="{% url 'respond_collaboration' req.id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="accept">
                                    <button type="submit" class="btn btn-primary btn-sm w-100">
                                        <i class="fas fa-check"></i> Accept
                                    </button>
                                </form>
                                <form class="collab-respond" method="post" action="{% url 'respond_collaboration' req.id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="decline">
                                    <button type="submit" class="btn btn-secondary btn-sm w-100">
                                        <i class="fas fa-times"></i> Decline
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No pending collaboration requests.</p>
                    </div>
                    {% endfor %}

                    {% for req in new_collab_requests %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <img src="{% if req.requester.avatar %}{{ req.requester.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ req.requester.name }}&background=0a66c2&color=fff{% endif %}" 
                                     class="avatar avatar-sm me-2" alt="{{ req.requester.name }}">
                                <div>
                                    <strong>{{ req.requester.name }}</strong>
                                </div>
                            </div>
                            <p class="mb-2"><strong>Project:</strong> {{ req.project.title|default:req.project.project_name }}</p>
                            {% if req.role %}<p class="mb-2"><strong>Role:</strong> {{ req.role }}</p>{% endif %}
                            <p class="mb-2 small">{{ req.message|truncatechars:100 }}</p>
                            <small class="text-muted">{{ req.created_at|date:"M d, H:i" }}</small>
                            <div class="mt-3 d-flex gap-2">
                                <form class="collab-respond" method="post" action="{% url 'respond_collaboration_new' req.id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="accept">
                                    <button type="submit" class="btn btn-primary btn-sm w-100">
                                        <i class="fas fa-check"></i> Accept
                                    </button>
                                </form>
                                <form class="collab-respond" method="post" action="{% url 'respond_collaboration_new' req.id %}" style="flex: 1;">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="decline">
                                    <button type="submit" class="btn btn-secondary btn-sm w-100">
                                        <i class="fas fa-times"></i> Decline
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('form.collab-respond').forEach(function(form){
        form.addEventListener('submit', function(e){
            e.preventDefault();
            const formData = new FormData(form);
            const targetUrl = form.getAttribute('action');
            fetch(targetUrl, {
                method: 'POST',
                headers: { 
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value, 
                    'X-Requested-With': 'XMLHttpRequest' 
                },
                body: new URLSearchParams(formData)
            }).then(r => r.json()).then(data => {
                if(data.success){
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed'));
                }
            }).catch(() => alert('Network error'));
        });
    });
});
</script>
{% endblock %}
