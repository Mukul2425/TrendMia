{% extends 'base.html' %}
{% load static %}

{% block title %}Trending | TRENDMIA{% endblock %}

{% block extra_css %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-fire"></i> Trending Projects & Tags</h2>
            <p class="text-muted">See what's popular in the TRENDMIA community</p>
        </div>
    </div>

    <!-- Tag Selection Form -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="mb-3">View Tag History</h5>
            <form method="POST" class="d-flex gap-2">
                {% csrf_token %}
                <select name="tag_dropdown" id="tag_dropdown" class="form-select" style="flex: 1;">
                    {% for tag, _ in tag_counts %}
                    <option value="{{ tag }}">{{ tag }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-chart-line"></i> View History
                </button>
            </form>
        </div>
    </div>

    <!-- Bar Chart -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="mb-3">Tag Popularity Chart</h5>
            <div id="plot" style="width: 100%; height: 500px;"></div>
        </div>
    </div>

    <!-- Selected Tag History -->
    {% if selected_tag %}
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="mb-3">History of "{{ selected_tag }}" Over Past Months</h5>
            <img src="{% static 'dist/images/tag_history_plot.png' %}" alt="Tag History Plot" class="img-fluid">
        </div>
    </div>
    {% endif %}

    <!-- Predefined Tag Histories -->
    <div class="row">
        <div class="col-12 mb-4">
            <h4>Popular Tag Trends</h4>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-body">
                    <h6>Data Science</h6>
                    <img src="{% static 'dist/images/tag_history_plot_data_science.png' %}" alt="Data Science" class="img-fluid">
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-body">
                    <h6>AI</h6>
                    <img src="{% static 'dist/images/tag_history_plot_ai.png' %}" alt="AI" class="img-fluid">
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-body">
                    <h6>App Development</h6>
                    <img src="{% static 'dist/images/tag_history_plot_app_development.png' %}" alt="App Development" class="img-fluid">
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-body">
                    <h6>AR/VR</h6>
                    <img src="{% static 'dist/images/tag_history_plot_ar_vr.png' %}" alt="AR/VR" class="img-fluid">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Extract tag names and counts
const tags = [{% for tag, count in tag_counts %}'{{ tag }}',{% endfor %}];
const counts = [{% for tag, count in tag_counts %}{{ count }},{% endfor %}];

// Reverse for display
tags.reverse();
counts.reverse();

// Create color gradient
const maxCount = Math.max(...counts);
const minCount = Math.min(...counts);
const colors = counts.map(count => {
    const normalized = (count - minCount) / (maxCount - minCount || 1);
    const red = Math.round(10 + normalized * 245);
    const green = Math.round(102 + normalized * 153);
    const blue = Math.round(194);
    return `rgb(${red}, ${green}, ${blue})`;
});

// Plot the bar graph
Plotly.newPlot('plot', [{
    x: counts,
    y: tags,
    type: 'bar',
    orientation: 'h',
    marker: { color: colors }
}], {
    margin: { l: 150, r: 50, b: 50, t: 50, pad: 4 },
    xaxis: { title: 'Popularity Score' },
    yaxis: { title: 'Tags' },
    title: 'Trending Tags',
    paper_bgcolor: 'transparent',
    plot_bgcolor: 'transparent'
});
</script>
{% endblock %}
