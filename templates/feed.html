<!-- D:\Code Playground\demo django\myproject\templates\feed.html -->
<!-- feed.html -->

{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed | Trendmia</title>
    <link rel="stylesheet" type="text/css" href="{% static 'dist/css/feedStyle.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="feed-page">
    <!-- Navbar -->
    <div class="navbar">
        <div class="container">
            <div class="logo">
                <!-- Your logo image -->
                <img src="{% static 'dist/images/logo.svg' %}" alt="Logo">
                Trendmia
            </div>
            <!-- <div class="project-search">Search</div> -->   
            <div class="right-section">
                <a href="{% url 'feed' %}" class="nav-link active">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="{% url 'trending' %}" class="nav-link">
                    <i class="fas fa-chart-line"></i> Trending
                </a>
                <a href="{% url 'profile' %}" class="nav-link">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="{% url 'inbox' %}" class="nav-link">
                    <i class="fas fa-inbox"></i> Messages
                </a>
                <a href="{% url 'logout' %}" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </div>
    <div class="page-container">
        <!-- Left container for the profile flashcard -->
        <div class="left-container">
            <!-- Profile flashcard -->
            <a href="{% url 'profile' %}" class="profile-link">
                <div class="profile-flashcard" id="profileFlashcard">
                    {% if user.is_authenticated %}
                    <div class="profile-info">
                        {% if user.avatar %}
                            <img src="{{ user.avatar.url }}" alt="Profile Image">
                        {% else %}
                            <img src="{% static 'dist/images/logo.svg' %}" alt="Profile Image">
                        {% endif %}
                        <p class="welcome-message">Welcome, {{ user.name }}!</p>
                    </div>
                    <div class="dropdown">
                        <button class="dropbtn" id="profileDropdownBtn">&#9660;</button>
                        <div class="dropdown-content" id="profileDropdownContent">
                            <a href="{% url 'logout' %}" id="logoutBtn">Logout</a>
                        </div>
                    </div>
                    {% else %}
                    <p class="welcome-message">Welcome, Guest!</p>
                    {% endif %}
                </div>
                </a>
                    <!-- Filters removed as requested -->
        </div>

        <!-- Container for the feed section -->
        <div class="feed-container">
            <!-- Feed section -->
            <div class="feed-section">
                <!-- Post form -->
                <div class="post-form">
                    <h2>Post about your project:</h2>
                    <!-- "Create Project" button -->
                    <div class="create-project-button-container">
                        <button id="create-project-button" class="create-project-button">Create Project</button>
                    </div>
                    <form id="projectForm" method="POST" action="{% url 'post_project' %}">
                        {% csrf_token %}
                        <input type="text" name="heading" placeholder="Caption *" required><br>
                        <input type="text" name="project_name" placeholder="Project Title *" required><br>
                        <textarea name="project_description" rows="4" placeholder="Project Description *" required></textarea><br>

                        <div class="input-wrapper">
                            <label for="tags_select">Tags (Domains):</label><br>
                            <select id="tags_select" name="tags_select" multiple size="5" style="width:100%">
                                {% for tag in tags %}
                                    <option value="{{ tag.name }}">{{ tag.name }}</option>
                                {% endfor %}
                            </select>
                            <small>Select multiple with Ctrl/Cmd. Optional.</small>
                        </div>

                        <div class="input-wrapper">
                            <label for="status">Status:</label><br>
                            <select name="status" required>
                                <option value="ongoing">Ongoing</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="input-wrapper">
                            <label for="location">Location:(Optional)</label><br>
                            <input type="text" name="location" placeholder="Enter city name for nearby-collaborations">
                        </div>
                        <div class="button-group">
                            <button type="button" id="cancel-project-button"
                                class="cancel-project-button">Cancel</button>
                            <button type="submit" id="submit-project-button"
                                class="submit-project-button">Submit</button>
                        </div>
                    </form>

                </div>
                <!-- AI Recommendations Section -->
                {% if user.is_authenticated %}
                <div class="ai-recommendations">
                    <h3><i class="fas fa-robot"></i> Recommended for You</h3>
                    <p>Based on your interests and project history</p>
                </div>
                {% endif %}
                
                <!-- Posts by other users -->
                <div class="post-list">
                    {% for post in posts %}
                    <div class="post">
                        <div class="post-user-info">
                            <a href="{% url 'user_profile' post.user.username %}" class="user-link">
                                <div class="user-avatar-small">
                                    {% if post.user.avatar %}
                                        <img src="{{ post.user.avatar.url }}" alt="{{ post.user.name }}">
                                    {% else %}
                                        <img src="{% static 'dist/images/logo.svg' %}" alt="{{ post.user.name }}">
                                    {% endif %}
                                </div>
                                <div class="user-details">
                                    <span class="user-name">{{ post.user.name }}</span>
                                    <span class="user-handle">@{{ post.user.username }}</span>
                                </div>
                            </a>
                            <div class="post-header">
                                <p class="timesince">{{ post.created_at|timesince }} ago</p>
                            </div>
                        </div>
                        <div class="post-content">
                            <div class="post-caption">
                                <h3>{{ post.project_name }}</h3>
                                <p class="caption-text">{{ post.heading }}</p>
                            </div>
                            
                            <div class="post_image">
                                <img src="{% static 'dist/images/post1.jpeg' %}" alt="Post Image">
                            </div>
                            
                            <div class="project-details">
                                <p class="project-description">{{ post.project_description }}</p>
                                
                                {% if post.tags %}
                                <div class="project-tags">
                                    {% for tag in post.tags|split:"," %}
                                        <span class="tag">{{ tag|strip }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <div class="project-meta">
                                    <span class="project-status status-{{ post.status }}">
                                        <i class="fas fa-circle"></i> {{ post.status|title }}
                                    </span>
                                    {% if post.location %}
                                        <span class="project-location">
                                            <i class="fas fa-map-marker-alt"></i> {{ post.location }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="post-actions">
                                <!-- Follow/Unfollow button -->
                                {% if user.is_authenticated and user != post.user %}
                                <button class="follow-btn" data-username="{{ post.user.username }}" data-following="{% if post.is_following %}true{% else %}false{% endif %}">
                                    {% if post.is_following %}Unfollow{% else %}Follow{% endif %}
                                </button>
                                {% endif %}
                                
                                <!-- Chat button -->
                                <form action="{% url 'chat' post.user.username %}" method="get" style="display: inline;">
                                    <button type="submit">Initiate Chat</button>
                                </form>

                                {% if user.is_authenticated and user != post.user %}
                                <button class="collab-btn" data-project-id="{{ post.id }}" data-username="{{ post.user.username }}">Request Collaboration</button>
                                {% endif %}
                            </div>
                            
                            <!-- Comments section -->
                            <div class="comments-section">
                                <h4>Comments ({{ post.comments.count }})</h4>
                                <div class="comments-list" id="comments-{{ post.id }}">
                                    {% for comment in post.comments.all|slice:":5" %}
                                    <div class="comment">
                                        <strong>{{ comment.user.name }}</strong>: {{ comment.content }}
                                        <small>{{ comment.created_at|timesince }} ago</small>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                {% if user.is_authenticated %}
                                <form class="comment-form" data-project-id="{{ post.id }}">
                                    {% csrf_token %}
                                    <input type="text" name="content" placeholder="Add a comment..." required>
                                    <button type="submit">Comment</button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

            </div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            var profileDropdownBtn = document.getElementById('profileDropdownBtn');
            var profileDropdownContent = document.getElementById('profileDropdownContent');

            // Hide the logout button initially
            profileDropdownContent.style.display = 'none';

            profileDropdownBtn.addEventListener('click', function () {
                // Toggle visibility of the logout button
                profileDropdownContent.style.display = profileDropdownContent.style.display === 'none' ? 'block' : 'none';
            });
        });
        // for the post form 
        document.addEventListener('DOMContentLoaded', function () {
            var createProjectButton = document.getElementById('create-project-button');
            var projectForm = document.getElementById('projectForm');

            // Add click event listener to the button
            createProjectButton.addEventListener('click', function () {
                // Toggle visibility of the form
                projectForm.style.display = projectForm.style.display === 'none' ? 'block' : 'none';
            });
        });

        // Filter UI removed



        document.addEventListener('DOMContentLoaded', function () {
            var projectForm = document.getElementById('projectForm');
            projectForm.style.display = 'none';
            // Client-side required fields check
            projectForm.addEventListener('submit', function(e){
                var heading = projectForm.querySelector('input[name="heading"]').value.trim();
                var pname = projectForm.querySelector('input[name="project_name"]').value.trim();
                var pdesc = projectForm.querySelector('textarea[name="project_description"]').value.trim();
                var statusSel = projectForm.querySelector('select[name="status"]').value;
                var missing = [];
                if(!heading) missing.push('Caption');
                if(!pname) missing.push('Project Title');
                if(!pdesc) missing.push('Project Description');
                if(!statusSel) missing.push('Status');
                if(missing.length){
                    e.preventDefault();
                    alert('Please fill required fields: ' + missing.join(', '));
                }
            });
            
            // Handle follow/unfollow buttons
            document.querySelectorAll('.follow-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var username = this.getAttribute('data-username');
                    var isFollowing = this.getAttribute('data-following') === 'true';
                    
                    fetch('/follow/' + username + '/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'csrfmiddlewaretoken={{ csrf_token }}'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.textContent = data.action === 'followed' ? 'Unfollow' : 'Follow';
                            this.setAttribute('data-following', data.action === 'followed' ? 'true' : 'false');
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred');
                    });
                });
            });
            
            // Handle comment forms
            document.querySelectorAll('.comment-form').forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var projectId = this.getAttribute('data-project-id');
                    var content = this.querySelector('input[name="content"]').value;
                    
                    fetch('/comment/' + projectId + '/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'content=' + encodeURIComponent(content) + '&csrfmiddlewaretoken={{ csrf_token }}'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Add comment to the list
                            var commentsList = document.getElementById('comments-' + projectId);
                            var commentDiv = document.createElement('div');
                            commentDiv.className = 'comment';
                            commentDiv.innerHTML = '<strong>' + data.comment.user + '</strong>: ' + data.comment.content + 
                                                 ' <small>' + data.comment.created_at + '</small>';
                            commentsList.insertBefore(commentDiv, commentsList.firstChild);
                            
                            // Clear the form
                            this.querySelector('input[name="content"]').value = '';
                            
                            // Update comment count
                            var commentCount = this.previousElementSibling.querySelector('h4');
                            var currentCount = parseInt(commentCount.textContent.match(/\d+/)[0]) || 0;
                            commentCount.textContent = 'Comments (' + (currentCount + 1) + ')';
                        } else {
                            console.error('Comment error:', data.error);
                            // Show a more user-friendly error message
                            var errorDiv = document.createElement('div');
                            errorDiv.className = 'comment-error';
                            errorDiv.textContent = 'Failed to add comment. Please try again.';
                            errorDiv.style.color = '#ff6b6b';
                            errorDiv.style.fontSize = '12px';
                            errorDiv.style.marginTop = '5px';
                            this.appendChild(errorDiv);
                            setTimeout(() => errorDiv.remove(), 3000);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Show a more user-friendly error message
                        var errorDiv = document.createElement('div');
                        errorDiv.className = 'comment-error';
                        errorDiv.textContent = 'Network error. Please check your connection.';
                        errorDiv.style.color = '#ff6b6b';
                        errorDiv.style.fontSize = '12px';
                        errorDiv.style.marginTop = '5px';
                        this.appendChild(errorDiv);
                        setTimeout(() => errorDiv.remove(), 3000);
                    });
                });
            });

            // Handle collaboration requests
            document.querySelectorAll('.collab-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var projectId = this.getAttribute('data-project-id');
                    var username = this.getAttribute('data-username');
                    var role = prompt('Optional: specify your role (e.g., Designer, Backend Dev):', '');
                    fetch(`/collab/request/${projectId}/${username}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `role=${encodeURIComponent(role || '')}&csrfmiddlewaretoken={{ csrf_token }}`
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert('Collaboration request sent: ' + data.status);
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Network error');
                    })
                });
            });
        });

    </script>
</body>

</html>